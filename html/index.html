<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>ezytdl</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alata&amp;display=swap">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="assets/css/rotating.compiled.css">
    <link rel="stylesheet" href="assets/css/scroll.css">
    <link rel="stylesheet" href="assets/css/scrollbar.compiled.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>

<body style="background: rgb(10,10,10);width: 100vw;font-family: Alata, sans-serif;overflow-x: hidden;overflow-y: hidden;">
    <div id="background" style="width: 100vw;position: fixed;bottom: 0;right: 0;height: 100vh;opacity: 0;filter: blur(15px);background-size: cover;background-position: center center;"></div>
    <div style="position: sticky;bottom: 0;right: 0;">
        <div class="d-flex justify-content-between align-items-center" style="width: 100vw;height: 80px;padding: 24px;background: rgba(0,0,0,0.5);">
            <div class="container-fluid d-flex justify-content-start align-items-end" style="padding: 0px;">
                <h1 style="color: rgb(255,255,255);">ezytdl</h1>
                <h6 id="version" style="color: rgb(71,71,71);margin-bottom: 13px;">v0.0.0</h6>
            </div>
            <div class="container-fluid d-flex justify-content-end align-items-center" style="padding: 0px;"><a class="btn btn-primary" role="button" style="background: rgb(25,25,25);border-style: none;border-radius: 100px;margin: 0px 6px;" href="settings.html"><i class="fas fa-cog" style="margin-right: 6px;"></i>Settings</a></div>
        </div>
        <div class="d-inline-flex flex-column justify-content-start align-items-center" id="mainContainer" style="width: 100vw;/*overflow-y: scroll;*/">
            <div class="container-fluid d-flex justify-content-center align-items-center" id="urlBox" style="--bs-primary: #680dfd;--bs-primary-rgb: 104,13,253;--bs-success: #04a5ff;--bs-success-rgb: 4,165,255;--bs-info: #c29ad5;--bs-info-rgb: 194,154,213;--bs-dark: #1f1f1f;--bs-dark-rgb: 31,31,31;--bs-body-color: #ffffff;--bs-body-bg: #080808;width: min(500px, 80vw);height: calc(100vh - 80px);padding: 0px;"><input class="d-flex justify-content-center align-items-center" type="text" id="urlInput" style="background: rgba(88,88,88,0.11);border-width: 0px;border-radius: 100px;padding: 6px 16px;border-bottom-right-radius: 0px;border-top-right-radius: 0px;color: rgb(255,255,255);height: 36px;border-top-left-radius: 100px;width: 100%;" placeholder="Enter URL..."><button class="btn btn-primary" id="urlEnter" type="button" style="height: 36px;border-width: 0px;border-bottom-right-radius: 100px;border-top-right-radius: 100px;border-top-left-radius: 0px;border-bottom-left-radius: 0px;background: rgb(255,255,255, 0.85);color: rgb(0,0,0);padding-right: 15px;"><i class="fas fa-chevron-circle-right"></i></button></div>
            <h5 class="d-none" id="errorMsg" style="color: rgb(255,255,255);">Error Text</h5>
            <div id="listbox" style="width: min(500px, 80vw);margin-bottom: 30px;">
                <div class="container d-flex justify-content-between" style="background: rgba(33,33,33,0.55);border-top-left-radius: 26px;border-top-right-radius: 26px;padding: 4px 20px;padding-top: 8px;">
                    <h3 id="mediaTitle" style="color: rgb(255,255,255);font-weight: bold;">title</h3>
                </div>
                <div class="d-flex flex-column justify-content-start align-items-center" id="formatList" style="background: rgba(27,27,27,0.55);border-bottom-right-radius: 26px;border-bottom-left-radius: 26px;padding: 12px 0px;padding-bottom: 26px;">
                    <div class="d-flex justify-content-between align-items-center" id="formatCard" style="width: calc(100% - 40px);min-height: 50px;background: rgba(40,40,40,0.65);border-radius: 10px;padding: 0px 12px;margin-top: 12px;">
                        <div style="min-width: 340px;width: 340px;margin: 8px 0px;max-width: 340px;">
                            <div class="d-flex justify-content-start align-items-center" style="margin-bottom: 8px;">
                                <div class="container d-flex justify-content-between align-items-center" style="max-width: 44px;padding: 6px;background: #ffffff;border-radius: 100px;margin: 0px;margin-right: 6px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em" fill="currentColor" id="audioIcon" style="color: rgb(0,0,0);font-size: 12px;">
                                        <!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                                        <path d="M511.1 367.1c0 44.18-42.98 80-95.1 80s-95.1-35.82-95.1-79.1c0-44.18 42.98-79.1 95.1-79.1c11.28 0 21.95 1.92 32.01 4.898V148.1L192 224l-.0023 208.1C191.1 476.2 149 512 95.1 512S0 476.2 0 432c0-44.18 42.98-79.1 95.1-79.1c11.28 0 21.95 1.92 32 4.898V126.5c0-12.97 10.06-26.63 22.41-30.52l319.1-94.49C472.1 .6615 477.3 0 480 0c17.66 0 31.97 14.34 32 31.99L511.1 367.1z"></path>
                                    </svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -32 576 576" width="1em" height="1em" fill="currentColor" id="videoIcon" style="color: rgb(0,0,0);font-size: 12px;">
                                        <!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                                        <path d="M384 112v288c0 26.51-21.49 48-48 48h-288c-26.51 0-48-21.49-48-48v-288c0-26.51 21.49-48 48-48h288C362.5 64 384 85.49 384 112zM576 127.5v256.9c0 25.5-29.17 40.39-50.39 25.79L416 334.7V177.3l109.6-75.56C546.9 87.13 576 102.1 576 127.5z"></path>
                                    </svg></div>
                                <h5 id="formatName" style="color: rgb(255,255,255);margin: 0px;">format name</h5>
                            </div>
                            <ul id="formatMetaList" style="color: rgb(255,255,255);margin: 0px;margin-bottom: 11px;">
                                <li id="formatMetaVideoItem"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -32 576 576" width="1em" height="1em" fill="currentColor" style="margin-right: 5px;margin-top: -4px;">
                                        <!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                                        <path d="M384 112v288c0 26.51-21.49 48-48 48h-288c-26.51 0-48-21.49-48-48v-288c0-26.51 21.49-48 48-48h288C362.5 64 384 85.49 384 112zM576 127.5v256.9c0 25.5-29.17 40.39-50.39 25.79L416 334.7V177.3l109.6-75.56C546.9 87.13 576 102.1 576 127.5z"></path>
                                    </svg><strong id="txt">Bold</strong></li>
                                <li id="formatMetaAudioItem"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em" fill="currentColor" style="margin-right: 5px;margin-top: -4px;">
                                        <!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                                        <path d="M511.1 367.1c0 44.18-42.98 80-95.1 80s-95.1-35.82-95.1-79.1c0-44.18 42.98-79.1 95.1-79.1c11.28 0 21.95 1.92 32.01 4.898V148.1L192 224l-.0023 208.1C191.1 476.2 149 512 95.1 512S0 476.2 0 432c0-44.18 42.98-79.1 95.1-79.1c11.28 0 21.95 1.92 32 4.898V126.5c0-12.97 10.06-26.63 22.41-30.52l319.1-94.49C472.1 .6615 477.3 0 480 0c17.66 0 31.97 14.34 32 31.99L511.1 367.1z"></path>
                                    </svg><strong id="txt">Bold</strong></li>
                            </ul>
                            <h6 class="d-none" id="formatTags" style="color: rgb(255,255,255);font-size: 10px;">extra format tags</h6>
                            <div class="d-none" id="progressBar" style="width: 250px;min-width: 250px;max-width: 250px;height: 10px;min-height: 10px;max-height: 10px;background: #1f1f1f;border-radius: 100px;">
                                <div class="container" id="progressFill" style="border-radius: 100px;background: #ffffff;height: 10px;min-height: 10px;max-height: 10px;width: 10px;margin: 0px;padding: 0px;">
                                    <h1 style="margin: 0px;"></h1>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center" id="formatIdentifiers">
                            <h5 id="fileFormat" style="color: rgb(255,255,255);margin-top: 7px;">mp3</h5><button class="btn btn-primary d-flex justify-content-center align-items-center" id="formatDownload" type="button" style="height: 36px;border-width: 0px;background: rgb(255,255,255);color: rgb(0,0,0);border-radius: 100px;width: 36px;margin-left: 10px;padding: 4px;min-width: 36px;max-width: 36px;min-height: 36px;max-height: 36px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em" fill="currentColor" id="downloadicon">
                                    <!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                                    <path d="M480 352h-133.5l-45.25 45.25C289.2 409.3 273.1 416 256 416s-33.16-6.656-45.25-18.75L165.5 352H32c-17.67 0-32 14.33-32 32v96c0 17.67 14.33 32 32 32h448c17.67 0 32-14.33 32-32v-96C512 366.3 497.7 352 480 352zM432 456c-13.2 0-24-10.8-24-24c0-13.2 10.8-24 24-24s24 10.8 24 24C456 445.2 445.2 456 432 456zM233.4 374.6C239.6 380.9 247.8 384 256 384s16.38-3.125 22.62-9.375l128-128c12.49-12.5 12.49-32.75 0-45.25c-12.5-12.5-32.76-12.5-45.25 0L288 274.8V32c0-17.67-14.33-32-32-32C238.3 0 224 14.33 224 32v242.8L150.6 201.4c-12.49-12.5-32.75-12.5-45.25 0c-12.49 12.5-12.49 32.75 0 45.25L233.4 374.6z"></path>
                                </svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -32 576 576" width="1em" height="1em" fill="currentColor" class="d-none" id="fileicon">
                                    <!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. -->
                                    <path d="M147.8 192H480V144C480 117.5 458.5 96 432 96h-160l-64-64h-160C21.49 32 0 53.49 0 80v328.4l90.54-181.1C101.4 205.6 123.4 192 147.8 192zM543.1 224H147.8C135.7 224 124.6 230.8 119.2 241.7L0 480h447.1c12.12 0 23.2-6.852 28.62-17.69l96-192C583.2 249 567.7 224 543.1 224z"></path>
                                </svg></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><script>
    const mainContainer = document.getElementById(`mainContainer`);

    const searchBoxHeights = () => [`${window.innerHeight - 80}px`, `225px`]

    const urlBox = document.getElementById(`urlBox`);

    const input = document.getElementById(`urlInput`);
    const button = document.getElementById(`urlEnter`);

    const listbox = document.getElementById(`listbox`);

    const formatList = document.getElementById(`formatList`);

    const formatCard = document.getElementById(`formatCard`).cloneNode(true);
    document.getElementById(`formatCard`).remove();

    let currentInfo = null;

    const runSearch = (url) => {
        window.scrollTo(0, 0);

        const infoRequest = new XMLHttpRequest();

        console.log(`running search for ${url}`)

        infoRequest.open("GET", `http://localhost:3000/fetchInfo/${url}`, true);

        const parseInfo = () => {
            const info = JSON.parse(infoRequest.responseText);

            currentInfo = info;
            
            input.disabled = false;
            button.disabled = false;
            
            document.body.style.overflowY = `scroll`;

            if(info.error) {
                document.getElementById(`errorMsg`).innerHTML = info.error;

                if(document.getElementById(`errorMsg`).classList.contains(`d-none`)) {
                    document.getElementById(`errorMsg`).classList.remove(`d-none`);
                };

                return;
            } else {                    
                listbox.querySelector(`#mediaTitle`).innerHTML = `[${info.webpage_url_domain}] ${info.title}`;

                if(info.thumbnails && info.thumbnails.length > 0) {
                    const thumbnail = info.thumbnails[info.thumbnails.length - 1];

                    console.log(`thumbnail:`, thumbnail);

                    const img = new Image();

                    img.addEventListener(`load`, () => {
                        if(currentInfo.webpage_url == info.webpage_url) {
                            document.getElementById(`background`).style.backgroundImage = `url(${thumbnail.url})`;

                            anime({
                                targets: `#background`,
                                opacity: [0, 0.15],
                                duration: 500,
                                easing: `easeOutQuad`
                            })
                        }
                    });

                    img.src = thumbnail.url;
                }

                console.log(info)
                
                for(entry of formatList.querySelectorAll(`#formatCard`)) {
                    entry.parentNode.removeChild(entry);
                    console.log(`removed previous format card`)
                }

                info.formats.map(format => {
                    if(format.audio_ext != `none` || format.acodec != `none` || format.asr || format.audio_channels) {
                        format.audio = true;
                    } else {
                        format.audio = false;
                    }

                    if(format.aspect_ratio || format.fps || format.height || format.width || format.resolution != `audio only` || format.vcodec != `none` || format.video_ext != `none`) {
                        format.video = true;
                    } else {
                        format.video = false;
                    };

                    return format;
                }).sort((a, b) => {
                    if(a.audio && a.video) {
                        return -1;
                    } else if(b.audio && b.video) {
                        return 1;
                    } else if(a.audio && !a.video) {
                        return -1;
                    } else if(b.audio && !b.video) {
                        return 1;
                    } else if(a.video && !a.audio) {
                        return -1;
                    } else if(b.video && !b.audio) {
                        return 1;
                    } else {
                        return 0;
                    }
                }).forEach((format) => {
                    //console.log(format)

                    const card = formatCard.cloneNode(true);

                    const formatName = card.querySelector(`#formatName`);

                    const list = card.querySelector(`#formatMetaList`);

                    const listMetaItems = {
                        video: list.querySelector(`#formatMetaVideoItem`).cloneNode(true),
                        audio: list.querySelector(`#formatMetaAudioItem`).cloneNode(true)
                    }

                    list.querySelector(`#formatMetaVideoItem`).remove();
                    list.querySelector(`#formatMetaAudioItem`).remove();

                    const tags = formatToTags(format)

                    formatName.innerHTML = tags.format;
                    if(tags.filesize) format.innerHTML += ` (${tags.filesize})`;
                    if(tags.drm) format.innerHTML += ` (DRM)`;

                    for (type of Object.keys(tags.meta)) {
                        console.log(`appending ${type} meta for ${tags.format}`)

                        if(listMetaItems[type]) {
                            for (key of Object.keys(tags.meta[type])) {
                                if(tags.meta[type][key] != `none`) {
                                    console.log(`appending ${key} meta with value ${tags.meta[type][key]}`)

                                    const item = listMetaItems[type].cloneNode(true);

                                    item.querySelector(`#txt`).innerHTML = key + `: ` + tags.meta[type][key];

                                    list.appendChild(item);
                                }
                            }
                        } else {
                            console.log(`no ${type} list item found`)
                        }
                    };

                    if(tags.extra.length > 0) {
                        card.querySelector(`#formatTags`).classList.remove(`d-none`);
                        card.querySelector(`#formatTags`).innerHTML = tags.extra.join(` | `);
                    }

                    card.querySelector(`#fileFormat`).innerHTML = format.ext;

                    if(format.audio) {
                        card.querySelector(`#audioIcon`).style.opacity = `100%`;
                    } else {
                        card.querySelector(`#audioIcon`).style.opacity = `35%`;
                    }

                    if(format.video) {
                        card.querySelector(`#videoIcon`).style.opacity = `100%`;
                    } else {
                        card.querySelector(`#videoIcon`).style.opacity = `35%`;
                    }

                    const btn = card.querySelector(`#formatDownload`)

                    btn.onclick = () => {
                        btn.disabled = true;

                        const bar = card.querySelector(`#progressBar`);
                        const fill = card.querySelector(`#progressFill`);

                        const dotSize = Number.parseInt(fill.style.width.replace(`px`, ``));
                        const range = Number.parseInt(bar.style.width.replace(`px`, ``)) - dotSize;

                        card.style.opacity = 0.5;

                        formatName.innerHTML = `Downloading...`;
                        
                        card.querySelector(`#fileFormat`).innerHTML = `--%`;

                        const ws = new WebSocket(`ws://localhost:3000/download`);

                        let location = `Somewhere on your computer :)`

                        ws.onopen = () => {
                            ws.send(JSON.stringify({
                                url: url,
                                format: format.format_id
                            }));
                        }

                        ws.onmessage = (o) => {
                            const m = JSON.parse(o.data);

                            location = m.saveLocation

                            if(m.percentNum) {
                                if(bar.classList.contains(`d-none`)) bar.classList.remove(`d-none`);

                                const setWidth = `${dotSize + (range * m.percentNum/100)}px`;
                                console.log(`Downloaded ${m.percentNum} -- bar width: ${setWidth}`)
                                fill.style.width = setWidth

                                let percent = `${m.percentNum}`;
                                if(percent.length == 1) percent = `0` + percent;

                                card.querySelector(`#fileFormat`).innerHTML = `${percent}%`;
                            };
                        }

                        ws.onclose = () => {
                            card.querySelector(`#fileFormat`).innerHTML = `Done!`;

                            btn.onclick = () => {
                                const req = new XMLHttpRequest();

                                req.open("GET", `http://localhost:3000/openFolder/${encodeURI(btoa(location))}`, true);
                                req.send();
                            }

                            card.querySelector(`#downloadicon`).classList.add(`d-none`);
                            card.querySelector(`#fileicon`).classList.remove(`d-none`);

                            btn.disabled = false;

                            card.style.opacity = 1;

                            formatName.innerHTML = `Saved to: ${location}`
                        }
                    }

                    formatList.appendChild(card);
                })

                if(listbox.classList.contains(`d-none`)) {
                    listbox.classList.remove(`d-none`);
                }

                anime({
                    targets: urlBox,
                    height: searchBoxHeights(),
                    duration: 500,
                    easing: `easeOutQuad`,
                })
            }
        }

        let parse = false;

        infoRequest.onload = () => {
            if(parse) {
                parseInfo();
            } else {
                parse = true;
            }
        }
        
        input.disabled = true;
        button.disabled = true;

        document.body.style.overflowY = `hidden`

        if(!document.getElementById(`errorMsg`).classList.contains(`d-none`)) {
            document.getElementById(`errorMsg`).classList.add(`d-none`);
        }

        if(!listbox.classList.contains(`d-none`)) {
            anime({
                targets: urlBox,
                height: searchBoxHeights().reverse(),
                duration: 500,
                easing: `easeOutQuad`,
                complete: () => {
                    listbox.classList.add(`d-none`);
                    
                    if(parse) {
                        parseInfo();
                    } else {
                        parse = true;
                    }
                }
            });

            anime({
                targets: `#background`,
                opacity: [0.15, 0],
                duration: 500,
                easing: `easeOutQuad`
            })
        } else if(parse) {
            parseInfo();
        } else {
            parse = true;
        }

        infoRequest.send();
    }

    const processURL = () => {
        const url = input.value;

        console.log (`clicc`, url)

        const genericUrlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/;

        const match = url.match(genericUrlRegex);

        console.log (`match`, match)

        if(match) runSearch(url)
    }

    button.onclick = () => processURL();
    
    input.addEventListener(`keyup`, (e) => {
        if(e.key == `Enter` || e.keyCode == 13) processURL();
    })
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/addFormatTags.js"></script>
    <script src="assets/js/version.js"></script>
</body>

</html>